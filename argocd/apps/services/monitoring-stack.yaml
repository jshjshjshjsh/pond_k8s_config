apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: monitoring-stack
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    # ğŸŒŸ í”„ë¡œë©”í…Œìš°ìŠ¤ ì»¤ë®¤ë‹ˆí‹° ê³µì‹ ì €ì¥ì†Œ
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 61.3.2  # ê²€ì¦ëœ ì•ˆì • ë²„ì „
    helm:
      values: |
        # 1. Grafana ì„¤ì •
        grafana:
          # ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ ê³ ì •
          admin:
            existingSecret: "grafana-admin-credentials"
            userKey: "admin-user"
            passwordKey: "admin-password"
        
          # Ingress ì—°ê²° (grafana.localë¡œ ì ‘ì†)
          ingress:
            enabled: true
            ingressClassName: nginx
            hosts:
              - grafana.127.0.0.1.nip.io
            path: /
            pathType: Prefix
        
          nodeSelector:
            role: ops-node

        # 2. Prometheus ì„¤ì •
        prometheus:
          prometheusSpec:
            # OTel Collectorë¥¼ ë°œê²¬í•´ì„œ ê¸ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ ì„¤ì •
            serviceMonitorSelectorNilUsesHelmValues: false
            serviceMonitorSelector: {}
            serviceMonitorNamespaceSelector: {}
            nodeSelector:
              role: ops-node
        
        # Prometheus Operator ì„¤ì •
        prometheusOperator:
          nodeSelector:
            role: ops-node

        # Alertmanager ì„¤ì •
        alertmanager:
          alertmanagerSpec:
            nodeSelector:
              role: ops-node

        # ê¸°íƒ€ ì»´í¬ë„ŒíŠ¸ (Kube-state-metrics ë“±)
        kube-state-metrics:
          nodeSelector:
            role: ops-node

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true # CRD ìš©ëŸ‰ì´ ì»¤ì„œ í•„ìˆ˜ ì„¤ì •